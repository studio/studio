#!/usr/bin/env bash

studio="$(dirname $(readlink -f $0))/.."

error() {
    echo "error: $*" >&2
    exit 1
}

#
# Preamble and checking.
#

[ $(uname -s) = "Linux" ]  || (error "error: 'uname -s' is not Linux")

# Check that nix is available
if ! type nix-build &>/dev/null; then
    cat <<EOF
command not found: nix-build

Please install the nix package manager:
  curl https://nixos.org/nix/install | sh

See https://nixos.org/nix/ for more information.
EOF
    exit 1
fi

#
# Run studio
#

nixopts="--pure -j 10 --show-trace"

runstudio() {
  attr="$1"
  shift
  export TMPDIR=$(mktemp -d)
  chmod 755 $TMPDIR
  trap "rm -rf $TMPDIR" EXIT
  nix-shell $nixopts --run "STUDIO_PATH=$studio $*" -E - <<EOF
    with import $studio;
    runCommandNoCC "studio" {
      nativeBuildInputs = [ nixUnstable xorg.xauth perl disasm xvfb_run $attr ];
    } ""
EOF
}

case "$1" in
    vnc)
        runstudio studio.studio-vnc studio-vnc
        ;;
    x11)
        runstudio studio.studio-x11 studio-x11
        ;;
    cache)
        runstudio "studio.studio-x11 studio.studio-vnc" "echo 'Cache retrieved...'"
        ;;
    test)
        runstudio studio.studio-test studio-test
        ;;
    decode)
        if [ $# != 3 ]; then
            echo "Usage: studio decode <input> <output>" >&2
            exit 1
        fi
        runstudio studio.studio-decode studio-decode "$2" "$3"
        ;;
    *)
        error "Usage: studio <vnc|x11|cache|test>"
        ;;
esac

